-- Tables order by dependency relatively (make sure a table is not referenced before it's created)
CREATE TABLE IF NOT EXISTS client (
	id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
	mail VARCHAR(255) NOT NULL UNIQUE,
	prenom VARCHAR(255) NOT NULL,
	nom VARCHAR(255) NOT NULL
);

CREATE TABLE IF NOT EXISTS staff (
	id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
	name VARCHAR(255) NOT NULL DEFAULT 'Staff'
);

CREATE TABLE IF NOT EXISTS discount (
	id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
	value INTEGER NOT NULL DEFAULT 0,
	code VARCHAR(255) NOT NULL,
    CONSTRAINT valid_discount_value CHECK (value >= 0 AND value <= 100)
);

CREATE TABLE IF NOT EXISTS typeOfSeat (
	id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    type VARCHAR(255) NOT NULL
);

CREATE TABLE IF NOT EXISTS sittingPlan (
	id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR(255) NOT NULL
);

CREATE TABLE IF NOT EXISTS seat (
	id VARCHAR(3) PRIMARY KEY,
	typeId INTEGER NOT NULL REFERENCES typeOfSeat(id)
        ON UPDATE CASCADE
        ON DELETE RESTRICT
);

CREATE TABLE IF NOT EXISTS sittingPlan_seat (
	sittingPlanId INTEGER NOT NULL REFERENCES sittingPlan(id)
        ON UPDATE CASCADE
        ON DELETE CASCADE,
	seatId VARCHAR(3) NOT NULL REFERENCES seat(id)
        ON UPDATE CASCADE
        ON DELETE RESTRICT,
	PRIMARY KEY(sittingPlanId, seatId)
);

CREATE TABLE IF NOT EXISTS typeOfEvent (
	id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
	name VARCHAR(255) NOT NULL,
	isFree BOOLEAN NOT NULL,
	needReservation BOOLEAN NOT NULL,
	sittingPlanId INTEGER NOT NULL REFERENCES sittingPlan(id)
        ON UPDATE CASCADE
        ON DELETE RESTRICT
);

CREATE TABLE IF NOT EXISTS event (
	id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
	typeId INTEGER NOT NULL REFERENCES typeOfEvent(id)
        ON UPDATE CASCADE
        ON DELETE RESTRICT,
	date DATE NOT NULL,
	hour TIME NOT NULL,
	dateFin DATE NOT NULL,
	heureFin TIME NOT NULL,
    CONSTRAINT valid_event_time CHECK (dateFin > date OR (dateFin = date AND heureFin > hour))
);

CREATE TABLE IF NOT EXISTS tarif (
	id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
	eventId INTEGER NOT NULL REFERENCES event(id)
        ON UPDATE CASCADE
        ON DELETE CASCADE,
	name VARCHAR(255) NOT NULL,
	price NUMERIC,
	discountId INTEGER REFERENCES discount(id)
		ON UPDATE CASCADE
		ON DELETE RESTRICT,
    CONSTRAINT unique_tarif_per_event UNIQUE(eventId, name)
);

CREATE TABLE IF NOT EXISTS event_seat_status (
	eventId INTEGER NOT NULL REFERENCES event(id)
        ON UPDATE CASCADE
        ON DELETE CASCADE,
	seatId VARCHAR(3) NOT NULL REFERENCES seat(id)
        ON UPDATE CASCADE
        ON DELETE RESTRICT,
	isTaken BOOLEAN NOT NULL,
	isHold BOOLEAN NOT NULL DEFAULT false,
	holdTime TIMESTAMP,
	PRIMARY KEY(eventId, seatId),
    CONSTRAINT hold_requires_time CHECK ((isHold = true AND holdTime IS NOT NULL) OR isHold = false)
);

CREATE TABLE IF NOT EXISTS reservation (
	id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
	eventId INTEGER NOT NULL REFERENCES event(id)
        ON UPDATE CASCADE
        ON DELETE RESTRICT,
	vendor INTEGER NOT NULL REFERENCES staff(id)
		ON UPDATE CASCADE
		ON DELETE RESTRICT,
	reservationTime TIMESTAMP NOT NULL DEFAULT now(),
	clientId INTEGER REFERENCES client(id)
		ON UPDATE CASCADE
		ON DELETE SET NULL,
    CONSTRAINT online_needs_user CHECK ((vendor = 1 AND clientId IS NOT NULL) OR vendor != 1)
);

CREATE TABLE IF NOT EXISTS ticket (
	id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    reservationId INTEGER NOT NULL REFERENCES reservation(id)
        ON UPDATE CASCADE
        ON DELETE CASCADE,
    eventId INTEGER NOT NULL REFERENCES event(id)
        ON UPDATE CASCADE
        ON DELETE CASCADE,
    seatId VARCHAR(3) REFERENCES seat(id)
        ON UPDATE CASCADE
        ON DELETE RESTRICT,
    tarifName VARCHAR(255) NOT NULL,
    isScanned BOOLEAN NOT NULL DEFAULT false,
    CONSTRAINT unique_seat_per_event UNIQUE (eventId, seatId)
);