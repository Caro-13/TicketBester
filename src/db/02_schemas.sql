-- physical arrangement
CREATE TABLE IF NOT EXISTS room (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    address VARCHAR(255) NOT NULL
);

CREATE TABLE IF NOT EXISTS sector(
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    supplement NUMERIC(10,2) NOT NULL DEFAULT 0,
    room_id INTEGER NOT NULL REFERENCES room(id)
        ON UPDATE CASCADE
        ON DELETE RESTRICT
);

CREATE TABLE IF NOT EXISTS type_of_seat (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    type VARCHAR(255) NOT NULL
);

CREATE TABLE IF NOT EXISTS seat (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR(10) NOT NULL,
    type_id INTEGER NOT NULL REFERENCES type_of_seat(id)
        ON UPDATE CASCADE
        ON DELETE RESTRICT,
    sector_id INTEGER NOT NULL REFERENCES sector(id)
        ON UPDATE CASCADE
        ON DELETE RESTRICT,
    room_id INTEGER NOT NULL REFERENCES room(id)
        ON UPDATE CASCADE
        ON DELETE RESTRICT,
    CONSTRAINT unique_seat_per_room UNIQUE(name, room_id)
);

CREATE TABLE IF NOT EXISTS configuration (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR(255)
);

CREATE TABLE IF NOT EXISTS config_with_sector (
    PRIMARY KEY (config_id,sector_id),
    config_id INTEGER REFERENCES configuration(id)
        ON UPDATE CASCADE
        ON DELETE RESTRICT,
    sector_id INTEGER REFERENCES sector(id)
        ON UPDATE CASCADE
        ON DELETE RESTRICT
);

CREATE TABLE IF NOT EXISTS type_of_event (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    is_free BOOLEAN NOT NULL,
    need_reservation BOOLEAN NOT NULL
);

CREATE TABLE IF NOT EXISTS event (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    type_id INTEGER NOT NULL REFERENCES type_of_event(id)
        ON UPDATE CASCADE
        ON DELETE RESTRICT,
    name VARCHAR(255) NOT NULL,
    start_at TIMESTAMP NOT NULL,
    end_at TIMESTAMP NOT NULL,
    room_id INTEGER NOT NULL REFERENCES room(id),
    config_id INTEGER NOT NULL REFERENCES configuration(id),
    status event_status NOT NULL DEFAULT 'on_sale',
    CONSTRAINT valid_event_time CHECK (end_at > start_at)
);

CREATE TABLE IF NOT EXISTS event_seat (
    PRIMARY KEY(event_id, seat_id),
    event_id INTEGER NOT NULL REFERENCES event(id)
        ON UPDATE CASCADE
        ON DELETE CASCADE,
    seat_id INTEGER NOT NULL REFERENCES seat(id)
        ON UPDATE CASCADE
        ON DELETE RESTRICT,
    status seat_status NOT NULL DEFAULT 'AVAILABLE'--,
    --hold_expires_at TIMESTAMP,
    --CONSTRAINT hold_requires_time CHECK ((status = 'HOLD' AND hold_expires_at IS NOT NULL) OR status != 'HOLD')
);

CREATE TABLE IF NOT EXISTS client (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    mail VARCHAR(255) NOT NULL UNIQUE,
    firstname VARCHAR(255) NOT NULL,
    lastname VARCHAR(255) NOT NULL
);

CREATE TABLE IF NOT EXISTS staff (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR(255) NOT NULL DEFAULT 'Staff'
);
-- Online vendor at id 1 always
INSERT INTO staff (id, name) VALUES (1, 'Online');

CREATE TABLE IF NOT EXISTS reservation (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    event_id INTEGER NOT NULL REFERENCES event(id)
        ON UPDATE CASCADE
        ON DELETE RESTRICT,
    vendor INTEGER NOT NULL REFERENCES staff(id)
        ON UPDATE CASCADE
        ON DELETE RESTRICT,
    status reservation_status NOT NULL DEFAULT 'pending',
    reservation_time TIMESTAMP NOT NULL DEFAULT now(),
    client_id INTEGER REFERENCES client(id)
        ON UPDATE CASCADE
        ON DELETE SET NULL,
    CONSTRAINT online_needs_user CHECK ((vendor = 1 AND client_id IS NOT NULL) OR vendor != 1)
);

CREATE TABLE IF NOT EXISTS discount (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    value INTEGER NOT NULL DEFAULT 0,
    code VARCHAR(255) NOT NULL,
    CONSTRAINT valid_discount_value CHECK (value >= 0 AND value <= 100)
);

CREATE TABLE IF NOT EXISTS tarif (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    event_id INTEGER NOT NULL REFERENCES event(id)
        ON UPDATE CASCADE
        ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    price NUMERIC(10,2),
    discount_id INTEGER REFERENCES discount(id)
        ON UPDATE CASCADE
        ON DELETE RESTRICT,
    CONSTRAINT unique_tarif_per_event UNIQUE(event_id, name)
);

CREATE TABLE IF NOT EXISTS ticket (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    reservation_id INTEGER NOT NULL REFERENCES reservation(id)
        ON UPDATE CASCADE
        ON DELETE CASCADE,
    event_id INTEGER NOT NULL REFERENCES event(id)
        ON UPDATE CASCADE
        ON DELETE CASCADE,
    seat_id INTEGER REFERENCES seat(id)
        ON UPDATE CASCADE
        ON DELETE RESTRICT,
    tarif_name VARCHAR(255) NOT NULL,
    CONSTRAINT unique_seat_per_event UNIQUE (event_id, seat_id),
    CONSTRAINT fk_event_seat FOREIGN KEY(event_id, seat_id)
        REFERENCES event_seat(event_id, seat_id)
        ON UPDATE CASCADE
        ON DELETE RESTRICT
);

CREATE TABLE IF NOT EXISTS payment (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    reservation_id INTEGER NOT NULL REFERENCES reservation(id)
        ON UPDATE CASCADE
        ON DELETE CASCADE,
    total NUMERIC (10,2) NOT NULL,
    method VARCHAR(50) NOT NULL,
    payed_at TIMESTAMP NOT NULL DEFAULT now()
);

CREATE TABLE IF NOT EXISTS scan_ticket (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    scan_time TIMESTAMP NOT NULL DEFAULT now(),
    staff_id INTEGER NOT NULL REFERENCES staff(id)
        ON UPDATE CASCADE
        ON DELETE RESTRICT,
    door VARCHAR(1) NOT NULL,
    ticket_id INTEGER UNIQUE REFERENCES ticket(id)
        ON UPDATE CASCADE
        ON DELETE CASCADE,
    CONSTRAINT unique_ticket_scan UNIQUE(ticket_id)
);